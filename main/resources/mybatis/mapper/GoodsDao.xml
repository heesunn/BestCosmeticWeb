<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.study.springboot.goods.dao.GoodsDao">
	<!-- 상품 등록 -->
	<insert id="upload">
		insert into BC_GOODS (BCG_KEY, BCG_CATEGORY, BCG_NAME, BCG_PRICE, BCG_DATE, BCG_STOCK, BCG_IMG, BCG_IMGDETAIL, BCG_INFO) 
			values (BC_GOODS_SEQ.nextval, #{param4}, #{param3}, #{param5}, sysdate, 0, #{param1}, #{param2}, #{param6})
	</insert>
	<!-- 전체 리스트 -->
	<select id="selectCount" resultType="_int">
		select count(*) as total from BC_GOODS
	</select>
	<select id="list" resultType="com.study.springboot.goods.dto.GoodsDto">
		select * from ( select rownum num, A.* from (
			select * from bc_goods order by bcg_date desc, bcg_key desc ) A 
			<![CDATA[where rownum <= #{param2}]]> ) B 
			where B.num >= #{param1}
	</select>
	<!-- 검색 -->
	<select id="selectCountSearch" resultType="_int">
		select count(*) as total from BC_GOODS where
		<choose>
			<when test="param1.equals('bcg_key')"> bcg_key = #{param2} </when>
			<when test="param1.equals('bcg_name')"> bcg_name like '%${param2}%' </when>
		</choose>
	</select>
	<select id="searchList" resultType="com.study.springboot.goods.dto.GoodsDto">
		select * from ( select rownum num, A.* from (
			select * from bc_goods where
			<choose>
				<when test="param3.equals('bcg_key')"> bcg_key = #{param4} </when>
				<when test="param3.equals('bcg_name')"> bcg_name like '%${param4}%' </when>
			</choose>
			order by bcg_date desc, bcg_key desc ) A 
			<![CDATA[where rownum <= #{param2}]]> ) B 
			where B.num >= #{param1}
	</select>
	<!-- 포인트메이크업 -->
	<select id="selectCountPoint" resultType="_int">
		select count(*) as total from BC_GOODS where BCG_CATEGORY = 'point'
	</select>
	<select id="pointList" resultType="com.study.springboot.goods.dto.GoodsDto">
		select * from ( select rownum num, A.* from (
			select * from bc_goods where bcg_category = 'point' order by bcg_date desc, bcg_key desc  ) A 
			<![CDATA[where rownum <= #{param2}]]> ) B 
			where B.num >= #{param1}
	</select>
	<!-- 상품 삭제 -->
	<delete id="delete">
		delete from bc_goods where bcg_key = #{param1}
	</delete>
	<!-- 상품 수정 -->
	<update id="modify">
		update bc_goods 
			set bcg_price = #{param2}*(100-#{param4})/100,
			    bcg_info = #{param3}, bcg_discount = #{param4}, bcg_mdpick = #{param5} 
			where bcg_key = #{param1}
	</update>
	<!-- 로우 1개 select -->
	<select id="opSelect" resultType="com.study.springboot.goods.dto.GoodsDto">
		select * from bc_goods where bcg_key = #{param1}
	</select>
	
	<!-- best뱃지 
	<select id="best" resultType="com.study.springboot.goods.dto.GoodsDto">
		select * from bc_goods <![CDATA[where rownum <=5 order by bcg_sale desc]]>
	</select>
	-->

	<update id="goodsTableUpdate2">
		update bc_goods set bcg_like = bcg_like-1 where bcg_key = #{param1}
	</update>

	<select id="likeCount" resultType="int">
		select count(*) from bc_like where bcm_num = #{param1} and bcg_key = #{param2}
	</select>

	<!--  
	<update id="goodsTableUpdate">
      merge into BC_GOODS using dual 
         on (BCM_NUM = #{param1} and BCG_KEY = #{param2} )
         when matched then 
         	update set bcg_like = bcg_like-1 where BCG_KEY = #{param1}
         when not matched then 
            update set bcg_like = bcg_like+1 where BCG_KEY = #{param1}     
   	</update>
   	-->
   	<update id="likeTableUpdate">
      merge into BC_LIKE using dual 
         on (BCM_NUM = #{param1} and BCG_KEY = #{param2} )
         when matched then
            update set bcl_date = sysdate 
            delete where BCM_NUM = #{param1} and BCG_KEY = #{param2}
         when not matched then 
            insert (BCM_NUM, BCG_KEY, BCL_DATE) values(#{param1}, #{param2}, sysdate)        
   	</update>
	<!-- 세션 있을때 -->
	<select id="sessionPointList" resultType="com.study.springboot.goods.dto.GoodsJoinLikes">
		select *
		from ( select rownum num, A.*
		from (select c.*, d.bcg_key item
		from bc_goods C , bc_like D
		where C.bcg_category = 'point'
		and C.BCG_key = D.bcg_key (+)
		and (D.bcm_num= #{param1} or d.bcm_num is null)
		order by C.bcg_date desc, C.bcg_key desc ) A
		where rownum &lt;= #{param2} ) B
		where B.num &gt;= #{param3}
	</select>
	<!-- 세션 없을때 -->
	<select id="seessionXPointList" resultType="com.study.springboot.goods.dto.GoodsJoinLikes">
		select *
		from ( select rownum num, A.*
		from (select c.*, d.bcg_key item
		from (select bcg_key
		from bc_like
		group by bcg_key) D,
		bc_goods C
		where C.bcg_category = 'point'
		and C.BCG_key = D.bcg_key (+)
		order by C.bcg_date desc, C.bcg_key desc  ) A
		where rownum &lt;= #{param1} ) B
		where B.num &gt;= #{param2}
	</select>
</mapper>
